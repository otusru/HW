## **СБОРКА ЯДРА LINUX 6.1.130**

### 1. Стать `root`

```bash
su
```

### 2. Обновить источники пакетов

```bash
echo "deb http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware" > /etc/apt/sources.list
apt update
```

```bash
apt list --upgradable
```

### 3. Установить все необходимые зависимости

```bash
apt install -y \
    build-essential \
    libncurses-dev \
    bison \
    flex \
    libssl-dev \
    bc \
    dwarves \
    pahole \
    libelf-dev \
    zlib1g-dev \
    git \
    make \
    gcc \
    dpkg-dev \
    fakeroot \
    rsync \
    kmod \
    cpio \
    python3 \
    curl
```

```bash
apt update
apt install -y \
    build-essential libncurses-dev bison flex libssl-dev bc \
    dwarves pahole libelf-dev zlib1g-dev git make gcc \
    dpkg-dev fakeroot rsync kmod cpio python3 curl
```


### 4. Очистить ненужные модули и проверка загруженных модулей

```bash
sudo modprobe -r bluetooth
sudo modprobe -r snd_hda_codec_hdmi
```

Проверь загруженные модули:

```bash
lsmod
```

### 5. Загрузить исходный код ядра

```bash
cd /usr/src
```

```bash
curl -O https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.1.130.tar.gz
```

```bash
tar -xvf linux-6.1.130.tar.gz
```

```bash
cd linux-6.1.130
```

### 6. Скопировать текущую конфигурацию ядра

```bash
cp -v /boot/config-$(uname -r) .config
```

### 7. Изменить конфигурацию (отключить ненужные опции)

```bash
./scripts/config \
--disable SECURITY_SELINUX \
--disable SECURITY_SMACK \
--disable SECURITY_TOMOYO \
--disable SECURITY_APPARMOR \
--disable SECURITY_YAMA \
--disable RANDOMIZE_BASE \
--disable CPU_MITIGATIONS \
--disable MITIGATION_SPECTRE_BHI \
--disable MITIGATION_RFDS \
--disable PAGE_TABLE_ISOLATION \
--disable ZSWAP \
--disable BPF \
--disable BPF_SYSCALL \
--disable BPF_JIT \
--disable BPF_EVENTS \
--disable BPFILTER \
--disable MODULE_SIG
```

### 8. Обновить конфигурацию

Базовая конфигурация

```bash
make defconfig            # Создает базовую конфигурацию по умолчанию от разработчиков ядра.
```

Минимальное ядро для железа

```bash
make localmodconfig       # Создает конфигурацию только для загруженных модулей текущей системы (минималистичная)
```

Если уже есть .config

```bash
make olddefconfig         # Обновляет существующую .config, задавая дефолтные значения для новых параметров.
```

### 9. Собрать .deb пакеты ядра

```bash
make -j$(nproc) deb-pkg 2> ../error.log
```

### 10. Проверить наличие ошибок

```bash
cat ../error.log
```

### 11. Установить новое ядро

```bash
ls -la ../ | grep deb
```

### 12. Установить новое ядро

```bash
cd ..
dpkg -i linux-image-6.1.130*.deb linux-headers-6.1.130*.deb
```

 ### 13. Перезагрузить систему

```bash
reboot
```

### 14. Проверить, что новое ядро загружено

После перезагрузки:

```bash
uname -r
```

Ожидаемый вывод:

```
6.1.130
```
